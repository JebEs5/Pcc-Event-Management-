<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PCC Events - User</title>
<style>
:root{--bg:#eef4ff;--primary:#2f7ff6;--card:#ffffff;--muted:#6b7b98;}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#0b2545}
header{background:var(--primary);color:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.title{font-weight:800}
.search-wrap{display:flex;align-items:center;gap:8px}
.search{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);width:320px;max-width:50vw}
.search-btn{background:white;color:var(--primary);border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
.notif-wrap{position:relative}
.notif-btn{background:transparent;border:none;color:white;font-size:18px;cursor:pointer;padding:8px;position:relative}
.red-dot{position:absolute;right:6px;top:6px;width:10px;height:10px;background:#ef4444;border-radius:999px;display:none;border:2px solid white}
.notif-dropdown{position:absolute;right:0;top:44px;width:340px;background:white;border-radius:8px;box-shadow:0 8px 30px rgba(2,6,23,0.12);overflow:hidden;display:none;z-index:60}
.notif-dropdown.open{display:block}
.notif-item{padding:10px;border-bottom:1px solid #eef6ff}
.container{max-width:980px;margin:18px auto;padding:12px}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
.event-item{background:white;padding:12px;border-radius:8px;margin-bottom:10px;border-left:5px solid var(--primary)}
.event-title{margin:0;font-weight:800}
.small{color:var(--muted);font-size:13px}
.floating{position:fixed;right:18px;bottom:20px;background:var(--primary);color:white;border:none;padding:14px;border-radius:999px;box-shadow:0 10px 30px rgba(47,127,246,0.18);cursor:pointer;font-size:20px}
.modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50;opacity:0;pointer-events:none;transition:all .12s ease}
.modal.open{opacity:1;pointer-events:auto}
.modal-card{width:100%;max-width:560px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 12px 40px rgba(2,6,23,0.3)}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6f3ff;margin-top:8px}
textarea{min-height:90px;resize:vertical}
@media (max-width:820px){.search{width:160px}.notif-dropdown{right:8px;width:260px}}
</style>
</head>
<body>
<header>
  <div class="title">PCC EVENTS</div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="search-wrap">
      <input id="searchInput" class="search" placeholder="Search by title or venue">
      <button id="searchBtn" class="search-btn">Search</button>
    </div>
    <div class="notif-wrap">
      <button id="notifBtn" class="notif-btn">ðŸ””<span id="redDot" class="red-dot"></span></button>
      <div id="notifDropdown" class="notif-dropdown"></div>
    </div>
  </div>
</header>

<div class="container">
  <div class="card">
    <h3 style="margin:0 0 10px 0">Your Event Applications</h3>
    <div id="eventList"></div>
  </div>
</div>

<button id="applyBtn" class="floating">ï¼‹</button>

<!-- Modal -->
<div id="modal" class="modal" onclick="closeModal()">
  <div class="modal-card" onclick="event.stopPropagation()">
    <h3 style="margin:0 0 8px 0">Event Application</h3>
    <label>Title</label><input id="evTitle" required>
    <label>Description</label><textarea id="evDesc"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1"><label>Organizer</label><input id="evOrg" required></div>
      <div style="flex:1"><label>Contact</label><input id="evContact" required></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1"><label>Venue</label>
        <select id="evVenue" required>
          <option value="">Select venue</option>
          <option>Library</option><option>Veranda</option><option>Aula Minor</option><option>Crown Jewel</option><option>Mini Stage</option>
        </select>
      </div>
      <div style="flex:1"><label>Date</label><input id="evDate" type="date" required></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1"><label>Start Time</label><input id="evStart" type="time" required></div>
      <div style="flex:1"><label>End Time</label><input id="evEnd" type="time" required></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button onclick="closeModal()" style="background:#f1f6ff;color:var(--primary);border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Back</button>
      <button id="submitApp" style="background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Submit</button>
    </div>
  </div>
</div>

<script>
const EVENTS_KEY = 'pcc_events_data_final';
const NOTIFS_KEY = 'pcc_notifs_final';

let events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
let notifs = JSON.parse(localStorage.getItem(NOTIFS_KEY) || '[]');

function save(){ localStorage.setItem(EVENTS_KEY, JSON.stringify(events)); }
function saveNotifs(){ localStorage.setItem(NOTIFS_KEY, JSON.stringify(notifs)); }

function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function renderList(list){
  const container = document.getElementById('eventList');
  container.innerHTML = '';
  if(!list.length){ container.innerHTML = '<div class="small">No events yet.</div>'; return; }
  list.forEach(e=>{
    const div = document.createElement('div');
    div.className = 'event-item';
    div.innerHTML = `<p class="event-title">${escapeHtml(e.title)}</p>
      <div class="small">${escapeHtml(e.date)} â€¢ ${escapeHtml(e.start)} - ${escapeHtml(e.end)} â€¢ ${escapeHtml(e.venue)}</div>
      <div style="margin-top:8px" class="small">Organizer: ${escapeHtml(e.organizer)} â€¢ ${escapeHtml(e.contact)} â€¢ Status: ${escapeHtml(e.status)}</div>
      <div style="margin-top:6px" class="small">${escapeHtml(e.desc||'')}</div>`;
    container.appendChild(div);
  });
}

function refresh(){
  events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
  notifs = JSON.parse(localStorage.getItem(NOTIFS_KEY) || '[]');
  renderList(events.filter(e=> e.createdBy === 'user'));
  updateNotifDot();
  renderNotifDropdown();
}

function updateNotifDot(){
  const hasNew = notifs.some(n=> !n.read);
  document.getElementById('redDot').style.display = hasNew ? 'block' : 'none';
}

function renderNotifDropdown(){
  const dd = document.getElementById('notifDropdown');
  dd.innerHTML = '';
  if(notifs.length === 0){ dd.innerHTML = '<div class="notif-item">No notifications</div>'; return; }
  notifs.slice().reverse().forEach(n=>{
    const div = document.createElement('div'); div.className = 'notif-item';
    div.innerHTML = `<div style="font-weight:700">${escapeHtml(n.title)}</div><div class="small">${escapeHtml(n.time)}</div>`;
    dd.appendChild(div);
  });
}

document.getElementById('notifBtn').addEventListener('click', ()=>{
  const dd = document.getElementById('notifDropdown');
  dd.classList.toggle('open');
  if(dd.classList.contains('open')){ notifs.forEach(x=> x.read = true); saveNotifs(); updateNotifDot(); renderNotifDropdown(); }
});

document.getElementById('applyBtn').addEventListener('click', ()=>{ document.getElementById('modal').classList.add('open'); });
function closeModal(){ document.getElementById('modal').classList.remove('open'); document.getElementById('evTitle').value=''; document.getElementById('evDesc').value=''; document.getElementById('evOrg').value=''; document.getElementById('evContact').value=''; document.getElementById('evVenue').value=''; document.getElementById('evDate').value=''; document.getElementById('evStart').value=''; document.getElementById('evEnd').value=''; }

document.getElementById('submitApp').addEventListener('click', ()=>{
  const title = document.getElementById('evTitle').value.trim();
  const desc = document.getElementById('evDesc').value.trim();
  const organizer = document.getElementById('evOrg').value.trim();
  const contact = document.getElementById('evContact').value.trim();
  const venue = document.getElementById('evVenue').value;
  const date = document.getElementById('evDate').value;
  const start = document.getElementById('evStart').value;
  const end = document.getElementById('evEnd').value;
  if(!title||!organizer||!contact||!venue||!date||!start||!end){ alert('Please fill required fields'); return; }
  const id = Date.now();
  events.push({id,title,desc,organizer,contact,venue,date,start,end,status:'pending',createdBy:'user',createdAt:Date.now()});
  save();
  // notify admin via ping
  localStorage.setItem('pcc_admin_ping', Date.now().toString());
  closeModal();
  refresh();
  alert('Application submitted.');
});

// Search button works only on click (not live)
document.getElementById('searchBtn').addEventListener('click', ()=>{
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const mine = events.filter(e=> e.createdBy === 'user');
  if(!q){ renderList(mine); return; }
  const filtered = mine.filter(e=> e.title.toLowerCase().includes(q) || e.venue.toLowerCase().includes(q));
  renderList(filtered);
});

window.addEventListener('storage', (e)=>{
  if(e.key === EVENTS_KEY || e.key === NOTIFS_KEY || e.key === 'pcc_admin_ping'){
    events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
    notifs = JSON.parse(localStorage.getItem(NOTIFS_KEY) || '[]');
    refresh();
  }
});

// init
refresh();
</script>
</body>
</html>
